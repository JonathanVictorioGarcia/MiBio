{% extends "base.html" %}
{% block title %}Estadísticas - Mibio{% endblock %}

{% block body %}
<div class="min-h-dvh grid md:grid-cols-[260px_1fr]">
  <!-- SIDEBAR unificado -->
  <aside class="bg-slate-900/70 border-r border-slate-800 p-4 md:sticky md:top-0 md:h-dvh overflow-auto no-scrollbar">
    {# si tu partial está en 'dashboard/partials/_sidebar_user.html', cambia la línea de abajo #}
    {% include "dashboard/_sidebar_user.html" %}
  </aside>

  <!-- MAIN -->
  <main class="p-4 md:p-8 bg-gradient-to-b from-slate-900 to-slate-950 text-slate-100">
    <!-- Header / Filtros -->
    <div class="rounded-2xl p-3 md:p-4 mb-6 grid gap-3 md:grid-cols-2 lg:grid-cols-3 items-center"
         style="background:linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,.05));">
      <h1 class="text-lg md:text-xl font-extrabold">Estadísticas</h1>
      <div class="flex gap-2">
        <select class="w-full rounded-xl px-3 py-2 text-sm bg-[#0b1220] border border-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
          <option>Últimos 7 días</option>
          <option>Últimos 30 días</option>
          <option>Este mes</option>
          <option>Personalizado…</option>
        </select>
        <select class="w-full rounded-xl px-3 py-2 text-sm bg-[#0b1220] border border-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
          <option>Todas las tarjetas</option>
          <option>Tarjeta: Portafolio</option>
          <option>Tarjeta: Restaurante</option>
        </select>
      </div>
      <div class="flex gap-2 md:justify-end">
        <button class="px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-sm">Exportar CSV</button>
        <button class="px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-sm">Compartir reporte</button>
      </div>
    </div>

    <!-- KPIs -->
    <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      <div class="p-4 rounded-2xl bg-[#0f172a] border border-[#1f2a44]">
        <div class="text-slate-400 text-sm">Vistas</div>
        <div class="flex items-end justify-between mt-2">
          <div class="text-2xl font-extrabold">1,284</div>
          <span class="text-emerald-400 text-sm">+12% ↑</span>
        </div>
        <canvas id="kpiViews" height="64" class="mt-3"></canvas>
      </div>
      <div class="p-4 rounded-2xl bg-[#0f172a] border border-[#1f2a44]">
        <div class="text-slate-400 text-sm">Compartidos</div>
        <div class="flex items-end justify-between mt-2">
          <div class="text-2xl font-extrabold">214</div>
          <span class="text-emerald-400 text-sm">+6% ↑</span>
        </div>
        <canvas id="kpiShares" height="64" class="mt-3"></canvas>
      </div>
      <div class="p-4 rounded-2xl bg-[#0f172a] border border-[#1f2a44]">
        <div class="text-slate-400 text-sm">Guardados de contacto</div>
        <div class="flex items-end justify-between mt-2">
          <div class="text-2xl font-extrabold">156</div>
          <span class="text-rose-400 text-sm">-3% ↓</span>
        </div>
        <canvas id="kpiSaves" height="64" class="mt-3"></canvas>
      </div>
      <div class="p-4 rounded-2xl bg-[#0f172a] border border-[#1f2a44]">
        <div class="text-slate-400 text-sm">Escaneos QR</div>
        <div class="flex items-end justify-between mt-2">
          <div class="text-2xl font-extrabold">392</div>
          <span class="text-emerald-400 text-sm">+21% ↑</span>
        </div>
        <canvas id="kpiQR" height="64" class="mt-3"></canvas>
      </div>
    </div>

    <!-- Charts -->
    <div class="grid lg:grid-cols-3 gap-4 mb-6">
      <div class="p-4 rounded-2xl bg-[#0f172a] border border-[#1f2a44] lg:col-span-2">
        <div class="flex items-center justify-between">
          <h3 class="font-bold">Tendencia de vistas</h3>
          <span class="text-slate-400 text-xs">diario</span>
        </div>
        <canvas id="lineViews" height="110" class="mt-4"></canvas>
      </div>
      <div class="p-4 rounded-2xl bg-[#0f172a] border border-[#1f2a44]">
        <h3 class="font-bold">Dispositivos</h3>
        <canvas id="pieDevices" height="110" class="mt-4"></canvas>
        <div class="mt-3 grid grid-cols-3 text-center text-sm text-slate-300">
          <div>Móvil</div><div>Desktop</div><div>Tablet</div>
        </div>
      </div>
    </div>

    <div class="grid lg:grid-cols-3 gap-4 mb-6">
      <div class="p-4 rounded-2xl bg-[#0f172a] border border-[#1f2a44]">
        <h3 class="font-bold">Top orígenes</h3>
        <ul class="mt-3 space-y-3 text-sm">
          <li class="flex justify-between"><span>QR impreso</span><span class="text-slate-300">42%</span></li>
          <li class="flex justify-between"><span>WhatsApp</span><span class="text-slate-300">28%</span></li>
          <li class="flex justify-between"><span>Instagram</span><span class="text-slate-300">18%</span></li>
          <li class="flex justify-between"><span>Directo</span><span class="text-slate-300">12%</span></li>
        </ul>
      </div>
      <div class="p-4 rounded-2xl bg-[#0f172a] border border-[#1f2a44]">
        <h3 class="font-bold">Clics en CTAs</h3>
        <canvas id="barCTAs" height="110" class="mt-4"></canvas>
      </div>
      <div class="p-4 rounded-2xl bg-[#0f172a] border border-[#1f2a44]">
        <h3 class="font-bold">Ubicaciones (top)</h3>
        <ul class="mt-3 space-y-3 text-sm">
          <li class="flex justify-between"><span>CDMX</span><span class="text-slate-300">312</span></li>
          <li class="flex justify-between"><span>Guadalajara</span><span class="text-slate-300">154</span></li>
          <li class="flex justify-between"><span>Monterrey</span><span class="text-slate-300">98</span></li>
          <li class="flex justify-between"><span>Puebla</span><span class="text-slate-300">61</span></li>
        </ul>
      </div>
    </div>

    <!-- Rendimiento por tarjeta + eventos -->
    <div class="grid lg:grid-cols-3 gap-4">
      <div class="p-4 rounded-2xl bg-[#0f172a] border border-[#1f2a44] lg:col-span-2 overflow-x-auto">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-bold">Rendimiento por tarjeta</h3>
          <span class="text-slate-400 text-xs">últimos 30 días</span>
        </div>
        <table class="w-full text-sm">
          <thead class="text-slate-400">
            <tr class="text-left">
              <th class="py-2">Tarjeta</th>
              <th class="py-2">Vistas</th>
              <th class="py-2">Compartidos</th>
              <th class="py-2">Guardados</th>
              <th class="py-2">QR</th>
              <th class="py-2">CTR CTA principal</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-800">
            <tr>
              <td class="py-3">Portafolio</td><td>542</td><td>88</td><td>52</td><td>120</td><td>8.2%</td>
            </tr>
            <tr>
              <td class="py-3">Restaurante</td><td>391</td><td>62</td><td>44</td><td>97</td><td>6.1%</td>
            </tr>
            <tr>
              <td class="py-3">Evento</td><td>351</td><td>64</td><td>38</td><td>175</td><td>5.4%</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="p-4 rounded-2xl bg-[#0f172a] border border-[#1f2a44]">
        <h3 class="font-bold">Actividad reciente</h3>
        <ul class="mt-3 space-y-3 text-sm">
          <li class="flex items-start gap-3">
            <span class="size-2 rounded-full bg-emerald-400 mt-2"></span>
            <div><b>QR escaneado</b> desde CDMX · <span class="text-slate-400">hace 5 min</span></div>
          </li>
          <li class="flex items-start gap-3">
            <span class="size-2 rounded-full bg-indigo-400 mt-2"></span>
            <div><b>Compartido</b> por WhatsApp · <span class="text-slate-400">hace 18 min</span></div>
          </li>
          <li class="flex items-start gap-3">
            <span class="size-2 rounded-full bg-sky-400 mt-2"></span>
            <div><b>Guardó contacto</b> (iOS) · <span class="text-slate-400">hace 1 h</span></div>
          </li>
        </ul>
      </div>
    </div>
  </main>
</div>

{# Cargamos Chart.js aquí mismo (base.html ya trae Tailwind) #}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const tinyOpts = (labels, data)=>({
    type:'line',
    data:{ labels, datasets:[{ data, tension:.35, fill:false, borderWidth:2 }] },
    options:{ plugins:{legend:{display:false}}, elements:{point:{radius:0}}, scales:{x:{display:false}, y:{display:false}} }
  });
  new Chart(document.getElementById('kpiViews'),  tinyOpts(['','','','','','',''], [6,7,8,7,9,11,10]));
  new Chart(document.getElementById('kpiShares'), tinyOpts(['','','','','','',''], [1,2,2,3,3,4,4]));
  new Chart(document.getElementById('kpiSaves'),  tinyOpts(['','','','','','',''], [3,3,2,3,2,2,3]));
  new Chart(document.getElementById('kpiQR'),     tinyOpts(['','','','','','',''], [4,5,5,6,7,8,7]));

  // Line views
  new Chart(document.getElementById('lineViews'), {
    type:'line',
    data:{
      labels:['Lun','Mar','Mié','Jue','Vie','Sáb','Dom','Lun','Mar','Mié','Jue','Vie','Sáb','Dom'],
      datasets:[{
        label:'Vistas',
        data:[90,120,130,110,150,180,160,140,170,190,210,185,205,220],
        tension:.35, borderWidth:2, fill:true,
        backgroundColor:'rgba(99,102,241,.15)', borderColor:'rgba(99,102,241,1)'
      }]
    },
    options:{
      plugins:{ legend:{display:false} },
      scales:{ x:{ grid:{ display:false } }, y:{ grid:{ color:'rgba(148,163,184,.15)'}} }
    }
  });

  // Devices
  new Chart(document.getElementById('pieDevices'), {
    type:'doughnut',
    data:{ labels:['Móvil','Desktop','Tablet'], datasets:[{ data:[68,26,6] }] },
    options:{ plugins:{ legend:{ display:false }}, cutout:'60%' }
  });

  // CTA clicks
  new Chart(document.getElementById('barCTAs'), {
    type:'bar',
    data:{ labels:['WhatsApp','Llamar','Sitio Web','Ubicación','Email'], datasets:[{ label:'Clicks', data:[210,124,178,73,46] }] },
    options:{
      plugins:{ legend:{ display:false } },
      scales:{ x:{ grid:{ display:false }}, y:{ grid:{ color:'rgba(148,163,184,.15)'}} }
    }
  });
</script>
{% endblock %}
