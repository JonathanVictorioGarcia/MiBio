{% extends "base.html" %}
{% block title %}Soporte - Mibio{% endblock %}

{% block body %}
<div class="min-h-dvh grid md:grid-cols-[260px_1fr]">
  <!-- SIDEBAR unificado -->
  <aside class="bg-slate-900/70 border-r border-slate-800 p-4 md:sticky md:top-0 md:h-dvh overflow-auto no-scrollbar">
    {# Ajusta la ruta si tu partial est√° en otra carpeta #}
    {% include "dashboard/_sidebar_user.html" %}
  </aside>

  <!-- MAIN -->
  <main class="bg-gradient-to-b from-slate-900 to-slate-950 text-slate-100">
    <div class="max-w-6xl mx-auto px-4 py-6 md:py-10">
      <!-- Header -->
      <div class="flex items-start md:items-center justify-between gap-4">
        <div>
          <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight">Soporte</h1>
          <p class="text-slate-400 mt-1">Estamos aqu√≠ para ayudarte: gu√≠as, tickets y contacto directo.</p>
        </div>
        <button id="openModalBtn" class="inline-flex items-center gap-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 px-4 py-2 font-semibold shadow">
          üìù Crear ticket
        </button>
      </div>

      <!-- System Status -->
      <section class="mt-6">
        {% if system_status.status == "operational" %}
        <div class="rounded-2xl border border-emerald-700/40 bg-emerald-900/20 px-4 py-3 flex items-center justify-between">
          <div class="flex items-center gap-3">
            <span class="size-3 rounded-full bg-emerald-400"></span>
            <div>
              <div class="font-semibold text-emerald-300">{{ system_status.message }}</div>
              <div class="text-xs text-emerald-200/80">Actualizado {{ system_status.updated_at }}</div>
            </div>
          </div>
          <a href="#" class="text-sm text-emerald-300 hover:underline">Ver p√°gina de estado</a>
        </div>
        {% else %}
        <div class="rounded-2xl border border-amber-700/40 bg-amber-900/20 px-4 py-3 flex items-center justify-between">
          <div class="flex items-center gap-3">
            <span class="size-3 rounded-full bg-amber-400"></span>
            <div>
              <div class="font-semibold text-amber-300">{{ system_status.message }}</div>
              <div class="text-xs text-amber-200/80">Actualizado {{ system_status.updated_at }}</div>
            </div>
          </div>
          <a href="#" class="text-sm text-amber-300 hover:underline">Ver incidentes</a>
        </div>
        {% endif %}
      </section>

      <!-- Search + Quick actions -->
      <section class="mt-6">
        <div class="grid md:grid-cols-[1fr_320px] gap-4">
          <!-- Search -->
          <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-4">
            <label class="text-sm text-slate-400">Busca en el centro de ayuda</label>
            <div class="mt-2 flex items-center gap-2">
              <input type="search" class="w-full rounded-xl bg-slate-800 border border-slate-700/60 px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-600/40"
                     placeholder="Escribe una palabra clave (ej. QR, GA4, plan)‚Ä¶" />
              <button class="rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700/70 px-3 py-2">Buscar</button>
            </div>
            <div class="mt-3 text-xs text-slate-500">Sugerencias: ‚Äúcompartir tarjeta‚Äù, ‚Äúestad√≠sticas‚Äù, ‚Äúintegraciones‚Äù.</div>
          </div>

          <!-- Quick links -->
          <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-4">
            <div class="grid grid-cols-2 gap-3">
              {% for q in quick_links %}
              <a href="{{ q.href }}" class="rounded-xl border {% if q.variant == 'primary' %}border-indigo-600/40 bg-indigo-600/20 text-indigo-200 hover:bg-indigo-500/25{% else %}border-slate-700/70 bg-slate-800 hover:bg-slate-700{% endif %} px-3 py-3 text-center font-semibold">
                <div class="text-xl">{{ q.icon }}</div>
                <div class="mt-1 text-sm">{{ q.name }}</div>
              </a>
              {% endfor %}
            </div>
            <div class="mt-3 text-[11px] text-slate-500">WhatsApp/Email se habilitan seg√∫n tu plan/regi√≥n.</div>
          </div>
        </div>
      </section>

      <!-- Help center categories -->
      <section id="help-center" class="mt-8">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-xl font-bold">Centro de ayuda</h2>
          <a href="#" class="text-sm text-indigo-300 hover:underline">Ver todos los art√≠culos</a>
        </div>
        <div class="grid md:grid-cols-3 gap-4">
          {% for c in help_categories %}
          <a href="#" class="rounded-2xl border border-slate-800 bg-slate-900/60 p-5 hover:bg-slate-900/80 transition">
            <div class="text-lg font-semibold">{{ c.title }}</div>
            <p class="text-slate-400 text-sm mt-1">{{ c.desc }}</p>
            <div class="mt-3 text-xs text-slate-500">{{ c.articles }} art√≠culos</div>
          </a>
          {% endfor %}
        </div>
      </section>

      <!-- My tickets + Hours/SLA -->
      <section class="mt-10 grid md:grid-cols-[1fr_340px] gap-5">
        <!-- Tickets -->
        <div class="rounded-2xl border border-slate-800 bg-slate-900/60 overflow-hidden">
          <div class="px-5 py-3 border-b border-slate-800 flex items-center justify-between">
            <div>
              <h3 class="font-bold">Mis tickets</h3>
              <p class="text-slate-400 text-xs">Historial reciente</p>
            </div>
            <button class="rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700/70 px-3 py-2 text-sm" id="openModalBtn2">Nuevo ticket</button>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full min-w-[640px] text-sm">
              <thead class="bg-slate-900/40 text-slate-400">
                <tr class="text-left">
                  <th class="px-5 py-3 font-semibold">ID</th>
                  <th class="px-5 py-3 font-semibold">Asunto</th>
                  <th class="px-5 py-3 font-semibold">Estado</th>
                  <th class="px-5 py-3 font-semibold">Actualizado</th>
                  <th class="px-5 py-3"></th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-800/80">
                {% for t in recent_tickets %}
                <tr>
                  <td class="px-5 py-3">{{ t.id }}</td>
                  <td class="px-5 py-3 text-slate-200">{{ t.subject }}</td>
                  <td class="px-5 py-3">
                    {% if t.status == "Resuelto" %}
                      <span class="text-emerald-300">‚óè</span> {{ t.status }}
                    {% elif t.status == "En progreso" %}
                      <span class="text-amber-300">‚óè</span> {{ t.status }}
                    {% else %}
                      <span class="text-slate-300">‚óè</span> {{ t.status }}
                    {% endif %}
                  </td>
                  <td class="px-5 py-3 text-slate-400">{{ t.updated }}</td>
                  <td class="px-5 py-3">
                    <a href="#" class="text-indigo-300 hover:underline">Ver</a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Hours & Contact -->
        <div class="space-y-5">
          <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-5">
            <div class="font-bold">Horario y SLA</div>
            <p class="text-sm text-slate-400 mt-1">{{ support_hours }}</p>
            <p class="text-xs text-slate-500 mt-2">{{ sla_note }}</p>
            <div class="mt-4 grid grid-cols-2 gap-3">
              <div class="rounded-xl border border-slate-800 bg-slate-800/50 p-3">
                <div class="text-xs text-slate-400">Tiempo medio respuesta</div>
                <div class="text-lg font-extrabold">2‚Äì4 h</div>
              </div>
              <div class="rounded-xl border border-slate-800 bg-slate-800/50 p-3">
                <div class="text-xs text-slate-400">Satisfacci√≥n (CSAT)</div>
                <div class="text-lg font-extrabold">96%</div>
              </div>
            </div>
          </div>

          <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-5">
            <div class="font-bold">Canales de contacto</div>
            <div class="mt-3 space-y-2 text-sm">
              <div class="flex items-center justify-between">
                <span>Chat en vivo</span>
                <a href="#" class="rounded-lg bg-slate-800 hover:bg-slate-700 border border-slate-700/70 px-3 py-1.5">Iniciar</a>
              </div>
              <div class="flex items-center justify-between">
                <span>Email</span>
                <a id="email" href="mailto:soporte@mibio.app" class="text-indigo-300 hover:underline">soporte@mibio.app</a>
              </div>
              <div class="flex items-center justify-between">
                <span>WhatsApp</span>
                <a id="whatsapp" href="#" class="text-indigo-300 hover:underline">Abrir WhatsApp</a>
              </div>
            </div>
            <p class="text-[11px] text-slate-500 mt-3">Algunos canales dependen del plan y la disponibilidad regional.</p>
          </div>
        </div>
      </section>

      <!-- FAQs -->
      <section class="mt-10">
        <h3 class="text-xl font-bold mb-4">Preguntas frecuentes</h3>
        <div class="grid md:grid-cols-2 gap-5">
          {% for f in faqs %}
          <div class="rounded-2xl border border-slate-800 bg-slate-900/60">
            <button class="w-full text-left px-5 py-4 flex items-center justify-between faq-head">
              <span class="font-semibold">{{ f.q }}</span>
              <span class="text-slate-400">+</span>
            </button>
            <div class="px-5 pb-5 hidden faq-body">
              <p class="text-slate-400 text-sm leading-relaxed">{{ f.a }}</p>
            </div>
          </div>
          {% endfor %}
        </div>
      </section>
    </div>
  </main>
</div>

<!-- Modal: New Ticket -->
<div id="ticketModal" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-black/60"></div>
  <div class="relative mx-auto max-w-xl mt-20 rounded-2xl border border-slate-700 bg-slate-900 p-5">
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-bold">Crear nuevo ticket</h3>
      <button id="closeModalBtn" class="text-slate-400 hover:text-slate-200">‚úï</button>
    </div>
    <form class="mt-4 grid gap-3">
      <div class="grid md:grid-cols-2 gap-3">
        <div>
          <label class="text-sm text-slate-400">Asunto</label>
          <input type="text" class="w-full rounded-xl bg-slate-800 border border-slate-700/60 px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-600/40" placeholder="Breve resumen">
        </div>
        <div>
          <label class="text-sm text-slate-400">Prioridad</label>
          <select class="w-full rounded-xl bg-slate-800 border border-slate-700/60 px-3 py-2">
            <option>Normal</option>
            <option>Alta</option>
            <option>Urgente</option>
          </select>
        </div>
      </div>
      <div>
        <label class="text-sm text-slate-400">Categor√≠a</label>
        <select class="w-full rounded-xl bg-slate-800 border border-slate-700/60 px-3 py-2">
          <option>Tarjetas</option>
          <option>Planes y facturaci√≥n</option>
          <option>Estad√≠sticas</option>
          <option>Integraciones</option>
          <option>Cuenta</option>
          <option>Otro</option>
        </select>
      </div>
      <div>
        <label class="text-sm text-slate-400">Descripci√≥n</label>
        <textarea rows="5" class="w-full rounded-xl bg-slate-800 border border-slate-700/60 px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-600/40" placeholder="Cu√©ntanos el detalle del problema‚Ä¶"></textarea>
      </div>
      <div>
        <label class="text-sm text-slate-400">Adjunto (opcional)</label>
        <input type="file" class="w-full rounded-xl bg-slate-800 border border-slate-700/60 px-3 py-2 file:mr-3 file:px-3 file:py-1.5 file:rounded-lg file:border-0 file:bg-slate-700 file:text-slate-100" />
      </div>
      <div class="flex items-center justify-end gap-2 mt-2">
        <button type="button" id="closeModalBtn2" class="rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700/70 px-4 py-2">Cancelar</button>
        <button type="button" class="rounded-xl bg-indigo-600 hover:bg-indigo-500 px-4 py-2 font-semibold">Enviar ticket</button>
      </div>
    </form>
  </div>
</div>

<!-- JS: FAQs + Modal -->
<script>
  // FAQ accordion
  document.querySelectorAll('.faq-head').forEach(h=>{
    h.addEventListener('click', ()=>{
      const body = h.parentElement.querySelector('.faq-body');
      const icon = h.querySelector('span:last-child');
      const open = body.classList.contains('hidden');
      document.querySelectorAll('.faq-body').forEach(b=>b.classList.add('hidden'));
      document.querySelectorAll('.faq-head span:last-child').forEach(i=>i.textContent = '+');
      if(open){ body.classList.remove('hidden'); icon.textContent = '‚àí'; }
    });
  });

  // Modal handlers
  const modal  = document.getElementById('ticketModal');
  const open1  = document.getElementById('openModalBtn');
  const open2  = document.getElementById('openModalBtn2');
  const close1 = document.getElementById('closeModalBtn');
  const close2 = document.getElementById('closeModalBtn2');

  function openModal(){ modal.classList.remove('hidden'); document.body.classList.add('overflow-hidden'); }
  function closeModal(){ modal.classList.add('hidden'); document.body.classList.remove('overflow-hidden'); }

  [open1, open2].forEach(b=> b && b.addEventListener('click', openModal));
  [close1, close2].forEach(b=> b && b.addEventListener('click', closeModal));
  modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });
</script>
{% endblock %}
